<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright 2020 TechnoLibre. (https://technolibre.ca)
     License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl). -->
<odoo>

    <template id="portal_invoice_approbation_page" name="Invoice Approbation Portal Template" inherit_id="account.portal_invoice_page">
        <xpath expr="//t[@t-set='entries']/ul/li/div[hasclass('o_download_pdf')]" position="before">
            <a t-if="invoice.has_to_be_signed(True)" role="button" class="btn btn-primary btn-block mb8" data-toggle="modal" data-target="#modalaccept" href="#">
                <i class="fa fa-check"/>
                Accept &amp; Sign
            </a>
        </xpath>

        <xpath expr="//div[@id='invoice_content']" position="attributes">
            <attribute name="class" remove="align-items-end" separator=" "></attribute>
        </xpath>

        <xpath expr="//div[@id='invoice_content']" position="inside">

            <!-- modal relative to the actions sign and pay -->
            <div role="dialog" class="modal fade" id="modalaccept">
                <div class="modal-dialog" t-if="invoice.has_to_be_signed(True)">
                    <form id="accept" method="POST" t-att-data-invoice-id="invoice.id" t-att-data-token="invoice.access_token" class="js_accept_json modal-content js_website_submit_form">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <header class="modal-header">
                            <h4 class="modal-title">Validate Draft Invoice</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&amp;times;</button>
                        </header>
                        <main class="modal-body" id="sign-dialog">
                            <p>
                                <span>By signing this invoice, I agree to the following terms:</span>
                                <ul>
                                    <li>
                                        <span>Accepted on the behalf of:</span>
                                        <b t-field="invoice.partner_id.commercial_partner_id"/>
                                    </li>
                                    <li>
                                        <span>For an amount of:</span>
                                        <b data-id="total_amount" t-field="invoice.amount_total"/>
                                    </li>
                                    <li t-if="invoice.payment_term_id">
                                        <span>With payment terms:</span>
                                        <b t-field="invoice.payment_term_id"/>
                                    </li>
                                </ul>
                            </p>
                            <t t-call="portal.portal_signature">
                                <t t-set="object" t-value="invoice"/>
                                <t t-set="partner_name" t-value="invoice.partner_id.name"/>
                                <t t-set="callUrl" t-value="invoice.get_portal_url(suffix='/accept')"/>
                                <t t-set="accessToken" t-value="invoice.access_token"/>
                            </t>
                        </main>
                    </form>
                </div>

                <div class="modal-dialog modal-content" t-if="not invoice.has_to_be_signed(True)">
                    <header class="modal-header">
                        <h4 class="modal-title">Validate Invoice</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">&amp;times;</button>
                    </header>
                    <main class="modal-body" id="sign-dialog">
                        <p>
                            <span>By paying this proposal, I agree to the following terms:</span>
                            <ul>
                                <li>
                                    <span>Accepted on the behalf of:</span>
                                    <b t-field="invoice.partner_id.commercial_partner_id"/>
                                </li>
                                <li>
                                    <span>For an amount of:</span>
                                    <b data-id="total_amount" t-field="invoice.amount_total"/>
                                </li>
                                <li t-if="invoice.payment_term_id">
                                    <span>With payment terms:</span>
                                    <b t-field="invoice.payment_term_id"/>
                                </li>
                            </ul>
                        </p>
                        <div t-if="pms or acquirers" id="payment_method" class="text-left">
                            <h3 class="mb24">Pay with</h3>
                            <t t-call="payment.payment_tokens_list">
                                <t t-set="mode" t-value="'payment'"/>
                                <t t-set="submit_txt">Pay &amp; Confirm</t>
                                <t t-set="icon_class" t-value="'fa-lock'"/>
                                <t t-set="form_action" t-value="invoice.get_portal_url(suffix='/transaction/token')"/>
                                <t t-set="prepare_tx_url" t-value="invoice.get_portal_url(suffix='/transaction/')"/>
                                <t t-set="access_token" t-value="invoice.access_token"/>
                            </t>
                        </div>
                    </main>
                </div>
            </div>

            <!-- modal relative to the action reject -->
            <div role="dialog" class="modal fade" id="modaldecline">
                <div class="modal-dialog">
                    <form id="decline" method="POST" t-attf-action="/my/invoices/#{invoice.id}/decline?access_token=#{invoice.access_token}" class="modal-content">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <header class="modal-header">
                            <h4 class="modal-title">Reject This Invoice</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">&amp;times;</button>
                        </header>
                        <main class="modal-body">
                            <p>
                                Tell us why you are refusing this invoice, this will help us improve our services.
                            </p>
                            <textarea rows="4" name="decline_message" required="" placeholder="Your feedback..." class="form-control"/>
                        </main>
                        <footer class="modal-footer">
                            <button type="submit" t-att-id="invoice.id" class="btn btn-danger">
                                <i class="fa fa-times"></i>
                                Reject
                            </button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                        </footer>
                    </form>
                </div>
            </div>

            <!-- status messages -->
            <div t-if="message == 'sign_ok'" class="alert alert-success alert-dismissable d-print-none" role="status">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
                <strong>Thank You!</strong>
                <br/>
                <t t-if="message == 'sign_ok' and invoice.state in ['sale', 'done']">Your invoice has been confirmed.</t>
                <t t-else="">Your invoice has been signed.</t>
            </div>

            <div t-if="message == 'cant_reject' and invoice.has_to_be_signed()" class="alert alert-danger alert-dismissable d-print-none" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">&amp;times;</button>
                Your invoice is not in a state to be rejected.
            </div>

            <t t-if="invoice.transaction_ids">
                <t t-call="payment.payment_confirmation_status">
                    <t t-set="payment_tx_id" t-value="invoice.get_portal_last_transaction()"/>
                    <t t-set="reference" t-value="invoice.reference"/>
                </t>
            </t>

            <!--            <div t-if="invoice.state == 'cancel'" class="alert alert-danger alert-dismissable d-print-none" role="alert">-->
            <!--                <button type="button" class="close" data-dismiss="alert" aria-label="close">&amp;times;</button>-->
            <!--                <strong>This quotation has been canceled.</strong>-->
            <!--                <a role="button" href="#discussion">-->
            <!--                    <i class="fa fa-comment"/>-->
            <!--                    Contact us to get a new quotation.-->
            <!--                </a>-->
            <!--            </div>-->

            <!--            <div t-if="invoice.state == 'draft'" class="alert alert-warning alert-dismissable d-print-none" role="status">-->
            <!--                <button type="button" class="close" data-dismiss="alert" aria-label="close">&amp;times;</button>-->
            <!--                <strong>This is a draft quotation.</strong>-->
            <!--                <a role="button" href="#discussion">-->
            <!--                    <i class="fa fa-comment"/>-->
            <!--                    Contact us to get the final version.-->
            <!--                </a>-->
            <!--            </div>-->

            <!-- main content -->
            <!--            <div t-attf-class="card #{'pb-5' if report_type == 'html' else ''}">-->
            <!--                <div t-call="sale.sale_order_portal_content"/>-->
            <!--            </div>-->

            <!-- bottom actions -->
            <div t-if="invoice.has_to_be_signed(True)" class="row justify-content-center text-center d-print-none pt-1 pb-4">
                <div class="col-sm-auto mt8">
                    <a role="button" class="btn btn-primary" data-toggle="modal" data-target="#modalaccept" href="#">
                        <i class="fa fa-check"/>
                        Accept &amp; Sign
                    </a>
                </div>
                <div class="col-sm-auto mt8">
                    <a data-toggle="modal" href="#" data-target="#invoice_chatter" class="btn btn-secondary">
                        <i class="fa fa-fw fa-comments"/>
                        <b>Feedback</b>
                    </a>
                </div>
                <!--
                <div class="col-sm-auto mt8">
                    <a role="button" class="btn btn-danger" data-toggle="modal" data-target="#modaldecline" href="#">
                        <i class="fa fa-times"/>
                        Reject
                    </a>
                </div>
                -->
            </div>

        </xpath>
    </template>
</odoo>
